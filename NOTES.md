## EF Core 6: Best Practices

- OVERVIEW:
  - The best patterns for data-centric solutions.
  - Prerequisites: .NET 6, C# 10, & EF Core.

- STRUCTURING YOUR PROJECT FOR CLEANLINESS & TESTABILITY:
  - EF Core 6. .NET 6. Visual Studio 2022. C# 10. Docker Desktop 4.3.2.
  - Seperation of concerns:
    - Security. Entity Relationships. Validation. Schema Evolution. Authentication. Authorization.
    - Representation. Paging. Sorting. Filtering. Aggregation. Logging. Governance. Representation.
  - [Clean Architecture Template](https://github.com/ardalis/cleanarchitecture):
    - API:
    - Infrastructure:
    - Domain:
    - Shared Kernel:
  - Remove storage concerns away from the domain model.
    - Repository Pattern:
      - Illusion of an in-memory collection of objects.
      - A specification is an object that describes a set of criteria.
      - Specification pattern. Encapsulates a LINQ expression. Do not polute the domain code.
      - Data storage should never leak into the domain layer.
      - DBSet provides the illusion of a collection of entities ready to use.
      - Specification: LINQ. Repository: DbSet<>. Database Interface: Query Provider.
  
  - DOMAIN: Use the generic DbContextOptions. Keep entity configuration(s) isolated.
  - INFRASTRUCTURE: Keep DB configuration seperate from application domain. Keep migrations seperate from model.
  - API: Configure dependencies at the top level.
  - Dependency Inversion Principle:
    - Depend upon abstract interfaces instead of concrete implementations.
  - SHARED KERNEL: Invert dependencies to defend seperation of concerns. Rely on IoC to satisfy dependencies.
  - How do we get a low-level component to call a higher-level component? Dependency inversion.
  - Fakes: Avoid unit testing EF and, obviously, SQL Server. Use the in-memory query provider.
    - EF Core In-Memory package.
  - UNIT TESTS: Use the in-memory auery provider. Isolate tests from one another. (X-Unit test project.)

- DESIGNING SECURITY INTO YOUR APPLICATION & PROCESS:
  - Why would an application ever need to drop a table? Principle of least privilege:
    - An actor should have only the privileges necessary to perform its function.
  - Database Operations:
    - DML: Data Manipulation Language: SELECT. INSERT. UPDATE. DELETE. db_datareader; db_datawriter;
    - DDL: Data Definition Language: CREATE. DROP. ALTER. TRUNCATE. db_ddladmin;
    - DCL: Data Control Language: GRANT. DENY. REVOKE. db_securityadmin;
  - Most permissive: db_owner; EF: Two (2) Actors:
    - Application: DML. db_datareader; db_datawriter;
    - Migrations: DML. DDL. DCL. db_datareader; db_datawriter; db_ddladmin; db_securityadmin; => db_owner;
  - (1) Change appsettings.json connection string. (2) Create a design-time DbContext factory for migrations, et al.
  - NOTE: Currently, migrations will use the same connection string as the running api. (Can use --connection flag via command line.)
  - Create a database role. Create an application login.
  - Shift Left: Consider application security in the early stages of the delivery process.
    - If developers operate under minimal privilidges during coding, any escalations that need to occur are then immediately observed.
    - Avoid secrets in appsettings.Developmnets.json.
    - %APPDATA%\Microsoft\UserSecrets\<user_secrets_id>\secrets.json
  - Within Visual Studio: Select "Manage User Secrets." (With VS COde: Install ".NET Core User Secrets.")
  - Deployment? Azure Key Vault. AWS Key Manager.
  - Azure: Configure managed identity for the app service. Set the connection string. Azure active directory.
  - "Active Directory Default" authentication.
  - Secure databases: Principle of least privilege. Application databse role. Design-time DbContext factory. 
    - Shift left. User secrets. Strongest available sevret manager.

- AUTOMATING SCHEMA EVOLUTION WITH MIGRATION BUNDLES & DOCKER:
  - 
